(function(r,C){typeof exports=="object"&&typeof module<"u"?C(exports):typeof define=="function"&&define.amd?define(["exports"],C):(r=typeof globalThis<"u"?globalThis:r||self,C(r.kkigomiPasskey={}))})(this,function(r){"use strict";let C;const v=e=>{C=e},S=e=>C+"?"+$.param({fn:e}),i=async(e,t)=>{const a={...{dataType:"json",method:"POST",headers:{},data:{requireResidentKey:!0,userVerification:"required"}},...t};return a.data&&(a.data=JSON.stringify(a.data)),await new Promise((u,c)=>{$.ajax(S(e),a).done(d=>{u(d)}).fail((d,p,K)=>{c(d.responseJSON.msg)})})},l=e=>{let t="",n=new Uint8Array(e),a=n.byteLength;for(let s=0;s<a;s++)t+=String.fromCharCode(n[s]);return window.btoa(t)},m=e=>{const t="=?BINARY?B?",n="?=";if(typeof e=="object")for(let a in e)if(typeof e[a]=="string"){let s=e[a];if(s.substring(0,t.length)===t&&s.substring(s.length-n.length)===n){s=s.substring(t.length,s.length-n.length);const u=window.atob(s),c=u.length,d=new Uint8Array(c);for(let p=0;p<c;p++)d[p]=u.charCodeAt(p);e[a]=d.buffer}}else m(e[a])};function w(){return(window==null?void 0:window.PublicKeyCredential)!==void 0&&typeof window.PublicKeyCredential=="function"}async function k(){const e=window.PublicKeyCredential;return e.isConditionalMediationAvailable!==void 0&&e.isConditionalMediationAvailable()}const o=window.$;let y;const f={webauthnSupported:!0,showAdvancedSettings:!1,formAction:"registration",options:{regRequireUserVerification:!0,attestation:"none",attachment:"all",algES256:!0,algRS256:!0,discoverableCredential:"preferred",authRequireUserVerification:!0},username:""},E=e=>{y=e.url,v(y+"/server.php"),w&&(e.isMember||k().then(async t=>t?await _():Promise.reject("\uD328\uC2A4\uD0A4 \uC790\uB3D9\uC120\uD0DD\uC744 \uC9C0\uC6D0\uD558\uC9C0 \uC54A\uB294 \uBE0C\uB77C\uC6B0\uC800")).then(()=>{}).catch(t=>{}),o(()=>{const t=o("body"),n=()=>{const a=o(".passkeys-register-keyname").val()||"";if(!a){alert("\uD0A4 \uC774\uB984\uC744 \uC785\uB825\uD574\uC8FC\uC138\uC694");return}return g(a)};t.on("click",".passkeys-action--add-key",a=>{a.preventDefault(),o(".passkeys-register-form").submit()}),t.on("submit",".passkeys-register-form",async a=>{a.preventDefault();const s=await n();console.debug("reg result",s),window.location.href=window.location.href}),t.on("click",".passkeys-action--remove-all",()=>{B().then(()=>{window.location.href=window.g5_url})}),t.on("click",".passkeys-action--remove-key",async a=>{const s=o(a.currentTarget).data("credential-id");await D(s),window.location.href=window.location.href}),t.on("click",".passkeys-action--add-key",()=>{})}))},_=async()=>(await function(){o(function(){const e=o("[name=mb_id]"),t=o("[name=mb_password]");let n=e.attr("autocomplete")||"";return n=[...new Set([...n.split(" "),"username","webauthn"])],e.attr("autocomplete",n.join(" ")),n=t.attr("autocomplete")||"",n=[...new Set([...n.split(" "),"current-password","webauthn"])],t.attr("autocomplete",n.join(" ")),Promise.resolve()})}(),h({conditionalUI:!0})),h=async e=>{const t=await A(e);return await R(t)},g=async e=>{if(!e){alert("\uD0A4 \uC774\uB984\uC744 \uC785\uB825\uD574\uC8FC\uC138\uC694");return}const t=await N({registerKeyName:e});return console.debug("register",t),t},b=async(e="passkey")=>{if(!w()){window.alert("\uC9C0\uC6D0\uD558\uC9C0 \uC54A\uB294 \uBE0C\uB77C\uC6B0\uC800\uC785\uB2C8\uB2E4.");return}const t={};if(e==="passkey"){const n=await A(t);return await I(n)}else if(e==="password"){const a=o("#passkey-session-auth-password").find("[type=password]").val();return await i("sessionAuth",{data:{data:{type:e,password:a}}})}},O=async e=>await i("sessionAuth",{data:{type:"password",password:e}}),T=async()=>{o(function(){return b("passkey").then(e=>{const t=e.memberId||"",n=e.providerName||"";if(e.success===!0){const a=o("[name=mb_password]").closest("form"),s=a.attr("action"),u=a.find("[name=w]").val(),c=o(`
          <form method="post" action="${s}" class="display: none;" />
        `);o(`
          <input type="hidden" name="w" value="${u}">
          <input type="hidden" name="mb_id" value="${t}" />
          <input type="hidden" name="provider" value="${n}">
        `).appendTo(c),c.appendTo("body"),c.submit()}}).catch(e=>{})})},A=async e=>{e.username=e.username||null,e.autoLogin=e.autoLogin||!1,e.conditionalUI=e.conditionalUI||!1;const t=await i("getCredentialRequestOptions",{data:{username:e.username,autoLogin:e.autoLogin}});if(t.success===!1)throw new Error(t.msg);m(t),e.conditionalUI===!0&&window.PublicKeyCredential.isConditionalMediationAvailable&&(t.mediation="conditional");const n=await navigator.credentials.get(t);return await{id:n.rawId?l(n.rawId):null,clientDataJSON:n.response.clientDataJSON?l(n.response.clientDataJSON):null,authenticatorData:n.response.authenticatorData?l(n.response.authenticatorData):null,signature:n.response.signature?l(n.response.signature):null,userHandle:n.response.userHandle?l(n.response.userHandle):null}},N=async e=>{const t=await P(e);return await q(t)},P=async e=>{const t=await i("getCredentialCreateOptions",{data:{userVerification:"required",requireResidentKey:1}});if(t.success===!1)throw new Error(t.msg);m(t),e.conditionalUI===!0&&window.PublicKeyCredential.isConditionalMediationAvailable&&(t.mediation="conditional");try{const n=await navigator.credentials.create(t);return await{authenticatorName:e.registerKeyName,clientDataJSON:n.response.clientDataJSON?l(n.response.clientDataJSON):null,attestationObject:n.response.attestationObject?l(n.response.attestationObject):null}}catch(n){n.name==="InvalidStateError"?alert("\uC774\uBBF8 \uB4F1\uB85D\uB41C \uD328\uC2A4\uD0A4 \uC785\uB2C8\uB2E4"):window.alert(n.message||"unknown error occured")}},R=async e=>{var a;const t=!!((a=document.querySelector("[name=auto_login]"))!=null&&a.checked),n=await i("authentication",{data:{...e,autoLogin:t}});if(n.success){let s=o('<form method="post" action="/bbs/login_check.php" />');const u=o('<input type="hidden" name="mb_id" />');u.val(n.member_id),u.appendTo(s),s.appendTo("body"),s.submit()}else throw new Error(n.msg,{cause:{exception:n.exception}})},q=async e=>{const t=await i("registrations",{data:{...e}});if(!t.success)throw new Error(t.msg,{cause:{exception:t.exception}});return t},I=async e=>{try{const t=await i("sessionAuth",{data:{...e}});if(!t.success)throw new Error(t.msg,{cause:{exception:t.exception}});return t}catch(t){alert(t)}},M=()=>{o("[data-remodal-id=passkey-modal]").remodal({}).open(),o("[data-remodal-id=passkey-modal]").find(".remodal-body").load(y+"/configuration.xhr.php")},U=async e=>{if(!w()){window.alert("\uC9C0\uC6D0\uD558\uC9C0 \uC54A\uB294 \uBE0C\uB77C\uC6B0\uC800\uC785\uB2C8\uB2E4.");return}let t;if(typeof e=="string"?f.username=e:e instanceof HTMLInputElement?(t=e,f.username=t.value):document.querySelector("[name=mb_id]")&&(t=document.querySelector("[name=mb_id]"),f.username=t.value),document.querySelector("[name=auto_login]").checked,!f.username){alert("\uD68C\uC6D0 \uC544\uC774\uB514\uB97C \uC785\uB825\uD574\uC8FC\uC138\uC694"),t&&t.focus();return}return h({username:f.username})},B=async()=>{if(!confirm(`\uB4F1\uB85D\uB41C \uD328\uC2A4\uD0A4\uB97C \uBAA8\uB450 \uC81C\uAC70\uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?
\uC81C\uAC70\uB41C \uD328\uC2A4\uD0A4\uB294 \uBCF5\uAD6C\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.`))return;const e=await i("clearRegistrations");if(e.success)window.alert(e.msg);else throw new Error(e.msg)},D=async e=>{await i("removeCredential",{data:{credentialId:e}})};r.boot=E,r.clearAllRegistration=B,r.login=U,r.manage=M,r.passwordSessionAuth=O,r.preferredSessionAuth=T,r.register=g,r.removeCredential=D,r.sessionAuth=b,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
